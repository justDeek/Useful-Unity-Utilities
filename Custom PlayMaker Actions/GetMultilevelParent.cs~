// (c) Copyright HutongGames, LLC 2010-2013. All rights reserved.
using UnityEngine;

namespace HutongGames.PlayMaker.Actions
{
	[ActionCategory(ActionCategory.GameObject)]
	[Tooltip("Gets the Game Object of a higher parent or lower child specified by an index.")]
	public class GetMultilevelGameObject : FsmStateAction
	{
		[RequiredField]
		[Tooltip("The GameObject to start from.")]
		public FsmOwnerDefault startFrom;

		[Tooltip("How many 'Directories' to go up or down. For example '2' would be the grandparent of the GameObject this FSM is attached to, '3' the parent of that one ... and so on. 0 returns the Owner. Anything below 0 goes in the other direction (-1 = Child)")]
		public FsmInt index;

		[UIHint(UIHint.Variable)]
		[Tooltip("The final GameObject it reached.")]
		public FsmGameObject storeResult;

		[Tooltip("The Name of the final GameObject it reached.")]
		public FsmGameObject storeName;

		[Tooltip("Follow the path it takes (throws Debug.Log's for every GameObject it passes). If there are several Log entries with the same GameObject, it means that the given index is higher than the GameObject has parents or lower than it has children.")]
		public FsmBool debug;

		public override void Reset()
		{
			startFrom = null;
			index = 1;
			storeResult = null;
			debug = false;
		}

		public override void OnEnter()
		{
			var go = Fsm.GetOwnerDefaultTarget(startFrom);
			if (go != null) 
			{
				//Get Owner
				if (index.Value == 0)
				{
					storeResult.Value = Owner;

					if (debug.Value == true)
					{
						Debug.Log ("GetMultilevelGameObject - Owner: " + Owner);
					}

				}

				//Get ascending parent
				if (index.Value >= 1)
				{
					for (int i = 0; i < index.Value; ++i) {
						try
						{
							go = go.transform.parent == null ? go : go.transform.parent.gameObject;	

							if (debug.Value == true)
							{
								var j = i + 1;
								Debug.Log ("GetMultilevelGameObject - Parent " + j.ToString () + ": " + go.transform.gameObject.name);
							}

							storeResult.Value = go;

						} catch(System.Exception e) {}

					}
				}

				//Get descending Child
				if (index.Value <= -1)
				{
					for (int i = 0; i < index.Value; --i) {
						try
						{
							go = go.transform.GetChild (i) == null ? go : go.transform.GetChild (i).gameObject;	

							if (debug.Value == true)
							{
								var j = i - 1;
								Debug.Log ("GetMultilevelGameObject - Child " + j.ToString () + ": " + go.transform.gameObject.name);
							}

							storeResult.Value = go;

						}
						catch (System.Exception NullReferenceException)
						{
							go = go.transform == null ? go : go.transform.gameObject;
							storeResult.Value = go;

							if (debug.Value == true)
								Debug.Log ("GetMultilevelGameObject - NullReferenceException: Current GameObject is null");

						}
					}
				}

			}
			else
			{
				storeResult.Value = null;
				if (debug.Value == true)
					Debug.Log ("GetMultilevelGameObject - NullReferenceException: 'Start From' is null");
			}
			Finish();
		}
	}
}